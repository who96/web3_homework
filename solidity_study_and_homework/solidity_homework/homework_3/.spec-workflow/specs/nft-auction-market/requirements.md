# 需求文档 - NFT拍卖市场

## 引言

基于[smartcontractkit/foundry-starter-kit](https://github.com/smartcontractkit/foundry-starter-kit)构建一个去中心化NFT拍卖市场平台。充分利用starter kit已有的Foundry配置、Chainlink Price Feed集成、标准项目结构和部署脚本，避免重复配置基础设施。采用渐进式开发策略：先实现核心拍卖功能，后扩展到可升级代理架构。该平台为NFT持有者提供安全、透明的拍卖渠道，为收藏者提供公平竞价环境。

## 与产品愿景对齐

本功能支撑以下核心目标：
- **复用成熟基础设施**：基于foundry-starter-kit避免90%的环境配置工作
- **快速集成Oracle服务**：直接复用已验证的PriceFeedConsumer.sol逻辑
- **标准化开发流程**：利用预配置的测试框架和部署脚本
- **消除攻击向量**：通过手动退款机制提升安全性
- **渐进式架构演进**：从简单实现到企业级可升级架构

## 需求

### 需求 1: NFT拍卖创建与管理

**用户故事：** 作为一名NFT持有者，我希望能够创建拍卖并设置拍卖参数，以便将我的NFT以市场化方式出售

#### 验收标准

1. 当用户拥有NFT且已授权给拍卖合约时，系统应当允许创建拍卖
2. 如果用户设置的拍卖时长少于3600秒，系统应当拒绝创建
3. 当拍卖创建成功时，系统应当将NFT锁定在合约中并生成唯一拍卖ID
4. 当拍卖到期时，系统应当自动标记拍卖结束状态
5. **Sepolia测试要求：** 每次合约部署后必须在Sepolia测试网进行拍卖创建交互测试

### 需求 2: 竞价与退款机制

**用户故事：** 作为一名NFT收藏者，我希望能够对拍卖进行出价并在被超越时手动提取退款，以便参与公平透明的竞价过程

#### 验收标准

1. 当用户出价高于当前最高价5%时，系统应当接受出价
2. 如果出价金额不足或拍卖已结束，系统应当拒绝出价
3. 当用户被其他出价超越时，系统应当允许手动调用withdrawRefund()提取退款
4. 当用户提取退款时，系统应当包含重入攻击防护机制
5. **Sepolia测试要求：** 多用户竞价场景和退款机制必须在Sepolia测试网验证

### 需求 3: 基于starter kit的Chainlink价格显示集成

**用户故事：** 作为一名平台用户，我希望看到ETH价格对应的USD等值显示，以便更好地评估拍卖价值

#### 验收标准

1. 当拍卖合约部署时，系统应当复用starter kit中PriceFeedConsumer.sol的已验证逻辑
2. 如果需要修改价格获取逻辑，系统应当基于已有的AggregatorV3Interface实现进行扩展
3. 当价格显示时，系统应当保证拍卖逻辑仍基于ETH计算，价格仅用于显示
4. 如果Oracle数据获取失败，系统应当显示错误提示但不影响拍卖核心功能
5. **Sepolia测试要求：** 复用starter kit已配置的Sepolia Price Feed地址进行集成测试

### 需求 4: 拍卖结算与资金分配

**用户故事：** 作为拍卖参与者，我希望拍卖结束后能够安全领取NFT或资金，以便完成交易流程

#### 验收标准

1. 当拍卖结束且有有效出价时，系统应当允许最高出价者领取NFT
2. 如果拍卖结束但无有效出价，系统应当允许卖家领取回NFT
3. 当资金分配时，系统应当正确扣除3%平台手续费
4. 当卖家领取资金时，系统应当确保资金安全转账
5. **Sepolia测试要求：** 完整拍卖流程包括NFT和资金领取必须在Sepolia验证

### 需求 5: 透明代理升级架构

**用户故事：** 作为平台管理者，我希望能够安全升级合约功能而不丢失用户数据，以便持续改进平台能力

#### 验收标准

1. 当部署代理架构时，系统应当使用OpenZeppelin透明代理模式
2. 如果升级新实现合约，系统应当保持存储布局兼容性
3. 当执行升级操作时，系统应当通过ProxyAdmin管理合约进行
4. 当升级完成后，系统应当保持所有历史拍卖数据完整
5. **Sepolia测试要求：** 代理部署和升级流程必须在Sepolia网络完整验证

## 非功能需求

### 代码架构与模块化
- **基础框架复用**：基于foundry-starter-kit的标准项目结构，保持src/、script/、test/目录规范
- **成熟组件集成**：复用已验证的PriceFeedConsumer.sol，避免重新实现Oracle逻辑
- **单一职责原则**：拍卖逻辑、NFT管理、价格显示分离为独立合约
- **模块化设计**：价格获取、退款机制、升级逻辑保持独立可复用
- **依赖管理**：利用starter kit预配置的Chainlink依赖，最小化额外依赖引入
- **清晰接口**：为拍卖合约与NFT合约定义标准化交互接口

### 性能
- Gas费用优化：单次拍卖创建不超过200k gas
- 批量查询支持：支持批量获取拍卖状态减少RPC调用
- 存储优化：使用packed结构体减少存储成本

### 安全
- 重入攻击防护：所有外部调用使用ReentrancyGuard
- 授权验证：严格验证NFT所有权和授权状态
- 资金安全：采用pull payment模式避免推送转账风险
- 升级安全：存储布局兼容性验证，禁止破坏性变更

### 可靠性
- Oracle故障容错：价格Feed失败不影响拍卖核心功能
- 网络恢复：支持交易失败后的状态恢复
- 数据一致性：确保拍卖状态与资金状态严格一致

### 易用性
- 清晰错误信息：提供用户友好的错误提示
- 状态透明：实时显示拍卖进度和用户操作状态
- 批量操作：支持批量退款和批量状态查询

### 测试网部署要求
- **基于starter kit配置**：利用已预配置的Sepolia RPC端点和Price Feed地址
- **复用部署脚本框架**：基于starter kit的部署脚本模板进行扩展，避免重写基础设施
- **每个开发阶段**必须包含Sepolia测试网部署和交互验证
- **每个功能模块**完成后立即进行Sepolia网络集成测试，特别验证Price Feed集成
- **每次合约修改**都要求重新部署到Sepolia并验证与starter kit组件的兼容性
- **完整流程验证**：从NFT铸造到拍卖完成的端到端Sepolia测试，验证所有Chainlink集成