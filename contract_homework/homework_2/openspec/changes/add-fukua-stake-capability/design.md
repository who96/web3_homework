# 设计文档: Fukua Stake 能力

## Context
Fukua Stake 要提供多资产质押、按区块奖励、锁定期解质押与紧急熔断能力。现有 `MetaNodeStake.sol` 已有基础逻辑，但缺乏明确的跨组件约束与前端/运维需求描述。本设计在编码前固化数据结构、流程与权限边界，让智能合约、脚本和前端保持一致。

**约束**
- 第一个池必须是原生 ETH (`address(0)`)，其余为 ERC20。
- 奖励代币 `MetaNode` 预铸并转入质押合约；奖励窗口限定在 `startBlock` ~ `endBlock`。
- 采用 UUPS 升级与 AccessControl 角色；需要全局熔断与细粒度暂停。
- 解质押资金需进入锁定队列，待区块高度达到后才能提款。

**相关方**
- 终端用户：期望清晰的质押、解质押、领取体验。
- 运营管理员：需要安全地调整参数、暂停入口、监控奖励池余额。
- 前端/脚本开发：需要准确的链上状态映射与事件驱动。

## Goals / Non-Goals

**Goals**
- 规范池、用户、解质押请求等核心数据结构。
- 明确奖励计算公式、结算触发点与锁定提现流程。
- 提供全局 `pause()/unpause()` 熔断与局部 `withdrawPaused` / `claimPaused`。
- 列出管理员操作（添加池、调整权重、更新奖励参数）及事件要求。
- 定义前端必须展示的状态字段与角色校验。

**Non-Goals**
- 不涉及多链部署或跨链奖励同步。
- 不引入可配置罚金或紧急提前赎回。
- 不扩展到自动复投或委托质押。
- 不定义 DAO/多签治理流程（后续可在新 change 中补充）。

## Decisions

### 奖励记账采用累积系数
- **决策**: 继续使用 `accMetaNodePerST`（放大 1e18）记录池级累计奖励。用户状态通过 `finishedMetaNode` 与 `pendingMetaNode` 计算增量。
- **原因**: 与现有合约一致，易于支持多池并行与精确分配；避免重复遍历质押者。
- **替代**: 逐笔发放或每用户独立时间戳 → gas 成本高，不可取。

### 解质押请求队列使用顺序数组
- **决策**: `UnstakeRequest[]` 继续按时间顺序累积，提现时从队首统计已解锁金额并原地压缩数组。
- **原因**: 逻辑简单，与锁定区块数要求匹配；每次 withdraw 的迭代成本与待处理请求数相等，可控。
- **替代**: 复杂的数据结构（如堆或双端队列）增加代码体积且无明显收益。

### 全局熔断 + 局部暂停并存
- **决策**: 暴露 `pause()/unpause()` 控制所有 `whenNotPaused` 流程，同时保留 `withdrawPaused`、`claimPaused` 精准控制提现/领取。
- **原因**: 遇到漏洞时可秒级冻结所有交互；常规运维仍可以单独限制提现或奖励。
- **替代**: 仅依赖布尔标志 → 无法阻止质押/解质押；仅全局暂停 → 缺少灵活度。

### 管理员参数调节即时生效
- **决策**: 更新开始/结束区块、每区块奖励、池权重等均即时生效，但需在规范中记录合法区间与顺序（如更新权重前可选 `massUpdatePools()`）。
- **原因**: 简化实现，无需长事务；管理员操作必须谨慎且配合事件通知。
- **替代**: 延迟生效或多步确认会增加复杂度，对作业项目价值有限。

### 前端状态以链上事件 + 定期轮询为主
- **决策**: 前端展示依赖 `View` 函数、高度信息与事件监听，不额外扩展 off-chain indexer 逻辑。
- **原因**: 作业体量有限，前端可直接基于 RPC 查询；事件保证状态同步。
- **替代**: 引入子图或后端服务不在本次范围。

## Risks / Trade-offs
- **奖励代币余额不足** → `claim` 会将剩余余额全部转出导致奖励折扣。**缓解**: 在规范中强制运营必须监控余额并及时补充；测试覆盖不足余额场景。
- **锁定队列膨胀** → 高频小额 `unstake` 可能造成数组迭代成本增长。**缓解**: 前端提示最小解质押单位；未来可通过批量操作优化。
- **管理员误操作参数** → 错误设置可能破坏奖励窗口。**缓解**: 规范中限制参数范围，并要求前端二次确认与事件记录。
- **暂停流程遗漏** → 若未实现 `pause()` 接口，熔断失效。**缓解**: tasks.md 明确实现，测试需覆盖暂停后各入口拒绝访问。

## Migration Plan
- 初始部署时：先创建 `MetaNodeToken`，铸造供应后转入质押合约；调用 `initialize` 设置奖励窗口。
- 升级流程：使用 UUPS `upgradeTo`，升级前暂停关键入口并备份存储；升级后运行 `massUpdatePools()` 确认状态一致。
- 紧急恢复：若发现漏洞，首先 `pause()`，然后配置 `withdrawPaused`/`claimPaused`，待修复部署新版本后 `unpause()`。

## Open Questions
- 是否需要对 `deposit()` 的 `>` 限制改为 `>=` 以与 ETH 池一致？（默认保持现状，后续需求另起变更）
- 是否提供批量提现或取消解质押请求？（当前不支持，如有需要需另起变更提案）
- 前端是否支持多语言与移动端适配？（未纳入本次目标）
