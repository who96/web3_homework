# 区块监控程序运行逻辑说明

## 程序概述
这是一个实时监控以太坊 Sepolia 测试网大额交易的程序，通过 WebSocket 订阅新区块事件。
  
  监控大额交易，可用于：
  - MEV 套利机会发现
  - DeFi 清算监控
  - 巨鲸地址追踪
  - Gas 价格分析

## 运行流程图
```
启动程序
    ↓
加载 .env 配置文件
    ↓
建立 WebSocket 连接 (wss://)
    ↓
订阅新区块头事件 (eth_subscribe)
    ↓
进入事件循环 ←─────────┐
    ↓                   │
等待新区块              │
    ↓                   │
收到区块头推送          │
    ↓                   │
获取完整区块数据        │
    ↓                   │
遍历区块中所有交易      │
    ↓                   │
筛选大额交易 (>0.1 ETH) │
    ↓                   │
显示交易详情            │
    └───────────────────┘
```

## 关键技术点

### 1. WebSocket vs HTTP
- **HTTP**: 请求-响应模式，客户端主动查询
- **WebSocket**: 双向通信，服务器可以主动推送
- 订阅必须用 `wss://`，不能用 `https://`

### 2. 以太坊单位转换
```
1 ETH = 10^18 Wei
0.1 ETH = 100000000000000000 Wei
```

### 3. Go Channel 机制
- `headers := make(chan *types.Header)` 创建通道
- `select` 语句同时监听多个通道
- 阻塞等待，有事件才处理

### 4. 交易签名机制
- 交易本身不包含发送方地址
- 需要通过 `types.Sender()` 从签名推导
- 使用 EIP-155 签名标准（防重放攻击）

### 5. 区块数据结构
```go
区块头 (Header)
├── Number (区块号)
├── Hash (区块哈希)
├── Time (时间戳)
└── GasUsed (Gas 使用量)

完整区块 (Block)
├── Header
└── Transactions[] (交易列表)
    ├── Hash (交易哈希)
    ├── Value (转账金额)
    ├── To (接收地址，可能为 nil)
    └── 签名数据 (v, r, s)
```

## 实际应用场景

### MEV 机器人
```go
// 监控 DEX 交易，发现套利机会
if isDEXTransaction(tx) {
    checkArbitrageOpportunity(tx)
}
```

### DeFi 清算
```go
// 监控借贷协议，发现可清算仓位
if isLendingProtocol(tx.To()) {
    checkLiquidationOpportunity(tx)
}
```

### 巨鲸追踪
```go
// 监控特定地址的大额转账
whaleAddresses := []string{"0x...", "0x..."}
if contains(whaleAddresses, from) {
    alertWhaleMovement(tx)
}
```

## 运行命令
```bash
cd examples
go run block_monitor.go
```

## 注意事项
1. Sepolia 测试网约 12 秒产生一个区块
2. 程序会持续运行，Ctrl+C 退出
3. 需要稳定的网络连接
4. WebSocket 断开会导致程序退出